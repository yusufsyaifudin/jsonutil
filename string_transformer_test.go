package jsonutil_test

import (
	"context"
	"encoding/json"
	"sync"
	"testing"

	"github.com/yusufsyaifudin/jsonutil"
)

// largeArray is from https://github.com/json-iterator/go/blob/v1.1.12/benchmarks/jsoniter_large_file_test.go
const largeArray = `[{"person":{"id":"d50887ca-a6ce-4e59-b89f-14f0b5d03b03","name":{"fullName":"Leonid Bugaev","givenName":"Leonid","familyName":"Bugaev"},"email":"leonsbox@gmail.com","gender":"male","location":"Saint Petersburg, Saint Petersburg, RU","geo":{"city":"Saint Petersburg","state":"Saint Petersburg","country":"Russia","lat":59.9342802,"lng":30.3350986},"bio":"Senior engineer at Granify.com","site":"http://flickfaver.com","avatar":"https://d1ts43dypk8bqh.cloudfront.net/v1/avatars/d50887ca-a6ce-4e59-b89f-14f0b5d03b03","employment":{"name":"www.latera.ru","title":"Software Engineer","domain":"gmail.com"},"facebook":{"handle":"leonid.bugaev"},"github":{"handle":"buger","id":14009,"avatar":"https://avatars.githubusercontent.com/u/14009?v=3","company":"Granify","blog":"http://leonsbox.com","followers":95,"following":10},"twitter":{"handle":"flickfaver","id":77004410,"bio":null,"followers":2,"following":1,"statuses":5,"favorites":0,"location":"","site":"http://flickfaver.com","avatar":null},"linkedin":{"handle":"in/leonidbugaev"},"googleplus":{"handle":null},"angellist":{"handle":"leonid-bugaev","id":61541,"bio":"Senior engineer at Granify.com","blog":"http://buger.github.com","site":"http://buger.github.com","followers":41,"avatar":"https://d1qb2nb5cznatu.cloudfront.net/users/61541-medium_jpg?1405474390"},"klout":{"handle":null,"score":null},"foursquare":{"handle":null},"aboutme":{"handle":"leonid.bugaev","bio":null,"avatar":null},"gravatar":{"handle":"buger","urls":[],"avatar":"http://1.gravatar.com/avatar/f7c8edd577d13b8930d5522f28123510","avatars":[{"url":"http://1.gravatar.com/avatar/f7c8edd577d13b8930d5522f28123510","type":"thumbnail"}]},"fuzzy":false},"company":"hello"}]`

const allJSONType = `{"string_only":"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.","string_quoted":"\"","uint":-1,"uint8":-1,"uint16":-1,"uint32":-1,"uint64":-1,"int":-1,"int8":-1,"int16":-1,"int32":-1,"int64":-1,"float32":1.1,"float64":1.1,"array_string":["Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.","Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.","Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.","Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."],"map":{"string_only":"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.","uint":-1,"uint8":-1,"uint16":-1,"uint32":-1,"uint64":-1,"int":-1,"int8":-1,"int16":-1,"int32":-1,"int64":-1,"float32":1.1,"float64":1.1,"array_string":["Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.","Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.","Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.","Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."],"map":{"foo":"bar"}}}`

const nestedObject100 = `{"1":{"2":{"3":{"4":{"5":{"6":{"7":{"8":{"9":{"10":{"11":{"12":{"13":{"14":{"15":{"16":{"17":{"18":{"19":{"20":{"21":{"22":{"23":{"24":{"25":{"26":{"27":{"28":{"29":{"30":{"31":{"32":{"33":{"34":{"35":{"36":{"37":{"38":{"39":{"40":{"41":{"42":{"43":{"44":{"45":{"46":{"47":{"48":{"49":{"50":{"51":{"52":{"53":{"54":{"55":{"56":{"57":{"58":{"59":{"60":{"61":{"62":{"63":{"64":{"65":{"66":{"67":{"68":{"69":{"70":{"71":{"72":{"73":{"74":{"75":{"76":{"77":{"78":{"79":{"80":{"81":{"82":{"83":{"84":{"85":{"86":{"87":{"88":{"89":{"90":{"91":{"92":{"93":{"94":{"95":{"96":{"97":{"98":{"99":{"100":{"final":"value"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}`

const nestedObject1000 = `{"1":{"2":{"3":{"4":{"5":{"6":{"7":{"8":{"9":{"10":{"11":{"12":{"13":{"14":{"15":{"16":{"17":{"18":{"19":{"20":{"21":{"22":{"23":{"24":{"25":{"26":{"27":{"28":{"29":{"30":{"31":{"32":{"33":{"34":{"35":{"36":{"37":{"38":{"39":{"40":{"41":{"42":{"43":{"44":{"45":{"46":{"47":{"48":{"49":{"50":{"51":{"52":{"53":{"54":{"55":{"56":{"57":{"58":{"59":{"60":{"61":{"62":{"63":{"64":{"65":{"66":{"67":{"68":{"69":{"70":{"71":{"72":{"73":{"74":{"75":{"76":{"77":{"78":{"79":{"80":{"81":{"82":{"83":{"84":{"85":{"86":{"87":{"88":{"89":{"90":{"91":{"92":{"93":{"94":{"95":{"96":{"97":{"98":{"99":{"100":{"101":{"102":{"103":{"104":{"105":{"106":{"107":{"108":{"109":{"110":{"111":{"112":{"113":{"114":{"115":{"116":{"117":{"118":{"119":{"120":{"121":{"122":{"123":{"124":{"125":{"126":{"127":{"128":{"129":{"130":{"131":{"132":{"133":{"134":{"135":{"136":{"137":{"138":{"139":{"140":{"141":{"142":{"143":{"144":{"145":{"146":{"147":{"148":{"149":{"150":{"151":{"152":{"153":{"154":{"155":{"156":{"157":{"158":{"159":{"160":{"161":{"162":{"163":{"164":{"165":{"166":{"167":{"168":{"169":{"170":{"171":{"172":{"173":{"174":{"175":{"176":{"177":{"178":{"179":{"180":{"181":{"182":{"183":{"184":{"185":{"186":{"187":{"188":{"189":{"190":{"191":{"192":{"193":{"194":{"195":{"196":{"197":{"198":{"199":{"200":{"201":{"202":{"203":{"204":{"205":{"206":{"207":{"208":{"209":{"210":{"211":{"212":{"213":{"214":{"215":{"216":{"217":{"218":{"219":{"220":{"221":{"222":{"223":{"224":{"225":{"226":{"227":{"228":{"229":{"230":{"231":{"232":{"233":{"234":{"235":{"236":{"237":{"238":{"239":{"240":{"241":{"242":{"243":{"244":{"245":{"246":{"247":{"248":{"249":{"250":{"251":{"252":{"253":{"254":{"255":{"256":{"257":{"258":{"259":{"260":{"261":{"262":{"263":{"264":{"265":{"266":{"267":{"268":{"269":{"270":{"271":{"272":{"273":{"274":{"275":{"276":{"277":{"278":{"279":{"280":{"281":{"282":{"283":{"284":{"285":{"286":{"287":{"288":{"289":{"290":{"291":{"292":{"293":{"294":{"295":{"296":{"297":{"298":{"299":{"300":{"301":{"302":{"303":{"304":{"305":{"306":{"307":{"308":{"309":{"310":{"311":{"312":{"313":{"314":{"315":{"316":{"317":{"318":{"319":{"320":{"321":{"322":{"323":{"324":{"325":{"326":{"327":{"328":{"329":{"330":{"331":{"332":{"333":{"334":{"335":{"336":{"337":{"338":{"339":{"340":{"341":{"342":{"343":{"344":{"345":{"346":{"347":{"348":{"349":{"350":{"351":{"352":{"353":{"354":{"355":{"356":{"357":{"358":{"359":{"360":{"361":{"362":{"363":{"364":{"365":{"366":{"367":{"368":{"369":{"370":{"371":{"372":{"373":{"374":{"375":{"376":{"377":{"378":{"379":{"380":{"381":{"382":{"383":{"384":{"385":{"386":{"387":{"388":{"389":{"390":{"391":{"392":{"393":{"394":{"395":{"396":{"397":{"398":{"399":{"400":{"401":{"402":{"403":{"404":{"405":{"406":{"407":{"408":{"409":{"410":{"411":{"412":{"413":{"414":{"415":{"416":{"417":{"418":{"419":{"420":{"421":{"422":{"423":{"424":{"425":{"426":{"427":{"428":{"429":{"430":{"431":{"432":{"433":{"434":{"435":{"436":{"437":{"438":{"439":{"440":{"441":{"442":{"443":{"444":{"445":{"446":{"447":{"448":{"449":{"450":{"451":{"452":{"453":{"454":{"455":{"456":{"457":{"458":{"459":{"460":{"461":{"462":{"463":{"464":{"465":{"466":{"467":{"468":{"469":{"470":{"471":{"472":{"473":{"474":{"475":{"476":{"477":{"478":{"479":{"480":{"481":{"482":{"483":{"484":{"485":{"486":{"487":{"488":{"489":{"490":{"491":{"492":{"493":{"494":{"495":{"496":{"497":{"498":{"499":{"500":{"501":{"502":{"503":{"504":{"505":{"506":{"507":{"508":{"509":{"510":{"511":{"512":{"513":{"514":{"515":{"516":{"517":{"518":{"519":{"520":{"521":{"522":{"523":{"524":{"525":{"526":{"527":{"528":{"529":{"530":{"531":{"532":{"533":{"534":{"535":{"536":{"537":{"538":{"539":{"540":{"541":{"542":{"543":{"544":{"545":{"546":{"547":{"548":{"549":{"550":{"551":{"552":{"553":{"554":{"555":{"556":{"557":{"558":{"559":{"560":{"561":{"562":{"563":{"564":{"565":{"566":{"567":{"568":{"569":{"570":{"571":{"572":{"573":{"574":{"575":{"576":{"577":{"578":{"579":{"580":{"581":{"582":{"583":{"584":{"585":{"586":{"587":{"588":{"589":{"590":{"591":{"592":{"593":{"594":{"595":{"596":{"597":{"598":{"599":{"600":{"601":{"602":{"603":{"604":{"605":{"606":{"607":{"608":{"609":{"610":{"611":{"612":{"613":{"614":{"615":{"616":{"617":{"618":{"619":{"620":{"621":{"622":{"623":{"624":{"625":{"626":{"627":{"628":{"629":{"630":{"631":{"632":{"633":{"634":{"635":{"636":{"637":{"638":{"639":{"640":{"641":{"642":{"643":{"644":{"645":{"646":{"647":{"648":{"649":{"650":{"651":{"652":{"653":{"654":{"655":{"656":{"657":{"658":{"659":{"660":{"661":{"662":{"663":{"664":{"665":{"666":{"667":{"668":{"669":{"670":{"671":{"672":{"673":{"674":{"675":{"676":{"677":{"678":{"679":{"680":{"681":{"682":{"683":{"684":{"685":{"686":{"687":{"688":{"689":{"690":{"691":{"692":{"693":{"694":{"695":{"696":{"697":{"698":{"699":{"700":{"701":{"702":{"703":{"704":{"705":{"706":{"707":{"708":{"709":{"710":{"711":{"712":{"713":{"714":{"715":{"716":{"717":{"718":{"719":{"720":{"721":{"722":{"723":{"724":{"725":{"726":{"727":{"728":{"729":{"730":{"731":{"732":{"733":{"734":{"735":{"736":{"737":{"738":{"739":{"740":{"741":{"742":{"743":{"744":{"745":{"746":{"747":{"748":{"749":{"750":{"751":{"752":{"753":{"754":{"755":{"756":{"757":{"758":{"759":{"760":{"761":{"762":{"763":{"764":{"765":{"766":{"767":{"768":{"769":{"770":{"771":{"772":{"773":{"774":{"775":{"776":{"777":{"778":{"779":{"780":{"781":{"782":{"783":{"784":{"785":{"786":{"787":{"788":{"789":{"790":{"791":{"792":{"793":{"794":{"795":{"796":{"797":{"798":{"799":{"800":{"801":{"802":{"803":{"804":{"805":{"806":{"807":{"808":{"809":{"810":{"811":{"812":{"813":{"814":{"815":{"816":{"817":{"818":{"819":{"820":{"821":{"822":{"823":{"824":{"825":{"826":{"827":{"828":{"829":{"830":{"831":{"832":{"833":{"834":{"835":{"836":{"837":{"838":{"839":{"840":{"841":{"842":{"843":{"844":{"845":{"846":{"847":{"848":{"849":{"850":{"851":{"852":{"853":{"854":{"855":{"856":{"857":{"858":{"859":{"860":{"861":{"862":{"863":{"864":{"865":{"866":{"867":{"868":{"869":{"870":{"871":{"872":{"873":{"874":{"875":{"876":{"877":{"878":{"879":{"880":{"881":{"882":{"883":{"884":{"885":{"886":{"887":{"888":{"889":{"890":{"891":{"892":{"893":{"894":{"895":{"896":{"897":{"898":{"899":{"900":{"901":{"902":{"903":{"904":{"905":{"906":{"907":{"908":{"909":{"910":{"911":{"912":{"913":{"914":{"915":{"916":{"917":{"918":{"919":{"920":{"921":{"922":{"923":{"924":{"925":{"926":{"927":{"928":{"929":{"930":{"931":{"932":{"933":{"934":{"935":{"936":{"937":{"938":{"939":{"940":{"941":{"942":{"943":{"944":{"945":{"946":{"947":{"948":{"949":{"950":{"951":{"952":{"953":{"954":{"955":{"956":{"957":{"958":{"959":{"960":{"961":{"962":{"963":{"964":{"965":{"966":{"967":{"968":{"969":{"970":{"971":{"972":{"973":{"974":{"975":{"976":{"977":{"978":{"979":{"980":{"981":{"982":{"983":{"984":{"985":{"986":{"987":{"988":{"989":{"990":{"991":{"992":{"993":{"994":{"995":{"996":{"997":{"998":{"999":{"1000":{"final":"value"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}`

// transformer will only Transform string value into xxx if and only if
// string is not in top level array.
// Means that ["hello"] will not be transformed.
// But, [{"foo": "hello"}] or {"foo": ["hello"]}
// will be transformed into [{"foo": "xxx"}], because "hello" is not in top level and have key "foo".
var transformer = func(keys []string) func(context.Context, jsonutil.KVInfo) string {
	return func(ctx context.Context, info jsonutil.KVInfo) string {
		if info.IsTopLevel && info.Inside == jsonutil.Array {
			return info.Value
		}

		for _, key := range keys {
			if key == info.Key {
				return "xxx"
			}
		}

		return info.Value
	}
}

type TestCase struct {
	Name       string
	Input      string
	MaskedKeys []string
	WantOutput string // minified version of JSON string
	WantErr    bool
}

// TestTransformer_TransformBytes_Test ensure test all condition
func TestTransformer_TransformBytes_Test(t *testing.T) {
	testCases := []TestCase{
		{
			Name:       `string only such as "abc" is a valid JSON`,
			Input:      `"abc"`,
			MaskedKeys: []string{"abc"},
			WantOutput: `"abc"`,
			WantErr:    false,
		},
		{
			Name:       `number only such as '1' is a valid JSON`,
			Input:      `1`,
			MaskedKeys: []string{"1"},
			WantOutput: `1`,
			WantErr:    false,
		},
		{
			Name:       `float number only such as '1.11' is a valid JSON`,
			Input:      `1.11`,
			MaskedKeys: []string{"1.11"},
			WantOutput: `1.11`,
			WantErr:    false,
		},

		// === Top Level Object
		{
			Name:       "top level kv string",
			Input:      `{"a": "b"}`,
			MaskedKeys: []string{"a"},
			WantOutput: `{"a":"xxx"}`,
			WantErr:    false,
		},
		{
			Name:       "top level kv: v contains object",
			Input:      `{"foo": {"a": "b"}}`,
			MaskedKeys: []string{"a"},
			WantOutput: `{"foo":{"a":"xxx"}}`,
			WantErr:    false,
		},
		{
			Name:       "top level kv: v contains mixed content",
			Input:      `{"foo": ["a",1]}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"foo":["xxx",1]}`,
			WantErr:    false,
		},
		{
			Name:       "top level kv, with v contains type but not string",
			Input:      `{"foo": 1}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"foo":1}`,
			WantErr:    false,
		},
		{
			Name:       "array contain multidimensional array",
			Input:      `{"mixed": [[{"foo": "bar"}]]}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"mixed":[[{"foo":"xxx"}]]}`,
			WantErr:    false,
		},

		// === Top Level Array
		{
			Name:       "top level array: strings only",
			Input:      `["a","b"]`,
			MaskedKeys: []string{"a"},
			WantOutput: `["a","b"]`,
			WantErr:    false,
		},
		{
			Name:       "top level with array of object",
			Input:      `[{"a":"b"}]`,
			MaskedKeys: []string{"a"},
			WantOutput: `[{"a":"xxx"}]`,
			WantErr:    false,
		},
		{
			Name:       `top level array, contains another array, multi-dimension array`,
			Input:      `[[{"foo":"bar"}]]`,
			MaskedKeys: []string{"foo"},
			WantOutput: `[[{"foo":"xxx"}]]`,
			WantErr:    false,
		},
		{
			Name:       "mixed content of top level array",
			Input:      `["amount", 100, {"a":"b"}]`,
			MaskedKeys: []string{"a"},
			WantOutput: `["amount",100,{"a":"xxx"}]`,
			WantErr:    false,
		},

		// === Nested Object
		{
			Name:       "Object contains object",
			Input:      `{"foo":{"another_obj":{"foo":"bar"}}}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"foo":{"another_obj":{"foo":"xxx"}}}`,
			WantErr:    false,
		},
		{
			Name:       "object contains array",
			Input:      `{"foo":{"another_obj":[{"foo":"bar"}]}}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"foo":{"another_obj":[{"foo":"xxx"}]}}`,
			WantErr:    false,
		},
		{
			Name:       "object contains elements other than string, object kv string or array",
			Input:      `{"foo": {"foo": 1}}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"foo":{"foo":1}}`,
			WantErr:    false,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.Name, func(t *testing.T) {
			config := jsonutil.Config{
				StringTransformer: transformer(tc.MaskedKeys),
			}

			mask := jsonutil.NewTransformer(config)
			out, err := mask.TransformBytes(context.Background(), []byte(tc.Input))
			if err != nil && !tc.WantErr {
				t.Errorf("code should not error, but got an error: \n\t%s", err)
				return
			}

			if string(out) != tc.WantOutput {
				t.Errorf("\nwant:\n \t%s \ngot:\n\t%s\n", tc.WantOutput, out)
				return
			}

			t.Logf("%s", out)
		})
	}
}

// TestTransformer_TransformBytes unit test with scenario resemble production usage.
func TestTransformer_TransformBytes(t *testing.T) {
	testCases := []TestCase{
		{
			Name:       "no valid json (key must be string)",
			Input:      `{1: 1}`,
			MaskedKeys: nil,
			WantOutput: "",
			WantErr:    true,
		},
		{
			Name:       "array contain mix string and object as value",
			Input:      `["hello", {"foo": "this should be masked"}]`,
			MaskedKeys: []string{"foo"},
			WantOutput: `["hello",{"foo":"xxx"}]`,
			WantErr:    false,
		},
		{
			Name:       "keys with array of string",
			Input:      `{"foo": ["this", "should", "be", "masked"]}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"foo":["xxx","xxx","xxx","xxx"]}`,
			WantErr:    false,
		},
		{
			Name:       "simple object",
			Input:      `{"foo": "bar"}`,
			MaskedKeys: []string{"foo"},
			WantOutput: `{"foo":"xxx"}`,
			WantErr:    false,
		},
		{
			Name:       "array of number",
			Input:      `[1,2]`,
			MaskedKeys: nil,
			WantOutput: `[1,2]`,
			WantErr:    false,
		},
		{
			Name:       "array of array of object",
			Input:      `[[{"foo":"bar"}]]`,
			MaskedKeys: []string{"foo"},
			WantOutput: `[[{"foo":"xxx"}]]`,
			WantErr:    false,
		},
		{
			Name:       "array of array of number",
			Input:      `[[1, 2], [3, 4]]`,
			MaskedKeys: nil,
			WantOutput: `[[1,2],[3,4]]`,
			WantErr:    false,
		},
		{
			Name:       "complex json (not retain the array order)",
			Input:      `[{"str": {"nest": "ini string"}, "nest": "hello", "nesting": ["ini", "string"]}]`,
			MaskedKeys: []string{"nest", "nesting"},
			WantOutput: `[{"nest":"xxx","nesting":["xxx","xxx"],"str":{"nest":"xxx"}}]`,
			WantErr:    false,
		},
		{
			Name:       "100 nested object",
			Input:      nestedObject100,
			MaskedKeys: []string{"final"},
			WantOutput: `{"1":{"2":{"3":{"4":{"5":{"6":{"7":{"8":{"9":{"10":{"11":{"12":{"13":{"14":{"15":{"16":{"17":{"18":{"19":{"20":{"21":{"22":{"23":{"24":{"25":{"26":{"27":{"28":{"29":{"30":{"31":{"32":{"33":{"34":{"35":{"36":{"37":{"38":{"39":{"40":{"41":{"42":{"43":{"44":{"45":{"46":{"47":{"48":{"49":{"50":{"51":{"52":{"53":{"54":{"55":{"56":{"57":{"58":{"59":{"60":{"61":{"62":{"63":{"64":{"65":{"66":{"67":{"68":{"69":{"70":{"71":{"72":{"73":{"74":{"75":{"76":{"77":{"78":{"79":{"80":{"81":{"82":{"83":{"84":{"85":{"86":{"87":{"88":{"89":{"90":{"91":{"92":{"93":{"94":{"95":{"96":{"97":{"98":{"99":{"100":{"final":"xxx"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}`,
			WantErr:    false,
		},
		{
			Name:       "1000 nested object",
			Input:      nestedObject1000,
			MaskedKeys: []string{"final"},
			WantOutput: `{"1":{"2":{"3":{"4":{"5":{"6":{"7":{"8":{"9":{"10":{"11":{"12":{"13":{"14":{"15":{"16":{"17":{"18":{"19":{"20":{"21":{"22":{"23":{"24":{"25":{"26":{"27":{"28":{"29":{"30":{"31":{"32":{"33":{"34":{"35":{"36":{"37":{"38":{"39":{"40":{"41":{"42":{"43":{"44":{"45":{"46":{"47":{"48":{"49":{"50":{"51":{"52":{"53":{"54":{"55":{"56":{"57":{"58":{"59":{"60":{"61":{"62":{"63":{"64":{"65":{"66":{"67":{"68":{"69":{"70":{"71":{"72":{"73":{"74":{"75":{"76":{"77":{"78":{"79":{"80":{"81":{"82":{"83":{"84":{"85":{"86":{"87":{"88":{"89":{"90":{"91":{"92":{"93":{"94":{"95":{"96":{"97":{"98":{"99":{"100":{"101":{"102":{"103":{"104":{"105":{"106":{"107":{"108":{"109":{"110":{"111":{"112":{"113":{"114":{"115":{"116":{"117":{"118":{"119":{"120":{"121":{"122":{"123":{"124":{"125":{"126":{"127":{"128":{"129":{"130":{"131":{"132":{"133":{"134":{"135":{"136":{"137":{"138":{"139":{"140":{"141":{"142":{"143":{"144":{"145":{"146":{"147":{"148":{"149":{"150":{"151":{"152":{"153":{"154":{"155":{"156":{"157":{"158":{"159":{"160":{"161":{"162":{"163":{"164":{"165":{"166":{"167":{"168":{"169":{"170":{"171":{"172":{"173":{"174":{"175":{"176":{"177":{"178":{"179":{"180":{"181":{"182":{"183":{"184":{"185":{"186":{"187":{"188":{"189":{"190":{"191":{"192":{"193":{"194":{"195":{"196":{"197":{"198":{"199":{"200":{"201":{"202":{"203":{"204":{"205":{"206":{"207":{"208":{"209":{"210":{"211":{"212":{"213":{"214":{"215":{"216":{"217":{"218":{"219":{"220":{"221":{"222":{"223":{"224":{"225":{"226":{"227":{"228":{"229":{"230":{"231":{"232":{"233":{"234":{"235":{"236":{"237":{"238":{"239":{"240":{"241":{"242":{"243":{"244":{"245":{"246":{"247":{"248":{"249":{"250":{"251":{"252":{"253":{"254":{"255":{"256":{"257":{"258":{"259":{"260":{"261":{"262":{"263":{"264":{"265":{"266":{"267":{"268":{"269":{"270":{"271":{"272":{"273":{"274":{"275":{"276":{"277":{"278":{"279":{"280":{"281":{"282":{"283":{"284":{"285":{"286":{"287":{"288":{"289":{"290":{"291":{"292":{"293":{"294":{"295":{"296":{"297":{"298":{"299":{"300":{"301":{"302":{"303":{"304":{"305":{"306":{"307":{"308":{"309":{"310":{"311":{"312":{"313":{"314":{"315":{"316":{"317":{"318":{"319":{"320":{"321":{"322":{"323":{"324":{"325":{"326":{"327":{"328":{"329":{"330":{"331":{"332":{"333":{"334":{"335":{"336":{"337":{"338":{"339":{"340":{"341":{"342":{"343":{"344":{"345":{"346":{"347":{"348":{"349":{"350":{"351":{"352":{"353":{"354":{"355":{"356":{"357":{"358":{"359":{"360":{"361":{"362":{"363":{"364":{"365":{"366":{"367":{"368":{"369":{"370":{"371":{"372":{"373":{"374":{"375":{"376":{"377":{"378":{"379":{"380":{"381":{"382":{"383":{"384":{"385":{"386":{"387":{"388":{"389":{"390":{"391":{"392":{"393":{"394":{"395":{"396":{"397":{"398":{"399":{"400":{"401":{"402":{"403":{"404":{"405":{"406":{"407":{"408":{"409":{"410":{"411":{"412":{"413":{"414":{"415":{"416":{"417":{"418":{"419":{"420":{"421":{"422":{"423":{"424":{"425":{"426":{"427":{"428":{"429":{"430":{"431":{"432":{"433":{"434":{"435":{"436":{"437":{"438":{"439":{"440":{"441":{"442":{"443":{"444":{"445":{"446":{"447":{"448":{"449":{"450":{"451":{"452":{"453":{"454":{"455":{"456":{"457":{"458":{"459":{"460":{"461":{"462":{"463":{"464":{"465":{"466":{"467":{"468":{"469":{"470":{"471":{"472":{"473":{"474":{"475":{"476":{"477":{"478":{"479":{"480":{"481":{"482":{"483":{"484":{"485":{"486":{"487":{"488":{"489":{"490":{"491":{"492":{"493":{"494":{"495":{"496":{"497":{"498":{"499":{"500":{"501":{"502":{"503":{"504":{"505":{"506":{"507":{"508":{"509":{"510":{"511":{"512":{"513":{"514":{"515":{"516":{"517":{"518":{"519":{"520":{"521":{"522":{"523":{"524":{"525":{"526":{"527":{"528":{"529":{"530":{"531":{"532":{"533":{"534":{"535":{"536":{"537":{"538":{"539":{"540":{"541":{"542":{"543":{"544":{"545":{"546":{"547":{"548":{"549":{"550":{"551":{"552":{"553":{"554":{"555":{"556":{"557":{"558":{"559":{"560":{"561":{"562":{"563":{"564":{"565":{"566":{"567":{"568":{"569":{"570":{"571":{"572":{"573":{"574":{"575":{"576":{"577":{"578":{"579":{"580":{"581":{"582":{"583":{"584":{"585":{"586":{"587":{"588":{"589":{"590":{"591":{"592":{"593":{"594":{"595":{"596":{"597":{"598":{"599":{"600":{"601":{"602":{"603":{"604":{"605":{"606":{"607":{"608":{"609":{"610":{"611":{"612":{"613":{"614":{"615":{"616":{"617":{"618":{"619":{"620":{"621":{"622":{"623":{"624":{"625":{"626":{"627":{"628":{"629":{"630":{"631":{"632":{"633":{"634":{"635":{"636":{"637":{"638":{"639":{"640":{"641":{"642":{"643":{"644":{"645":{"646":{"647":{"648":{"649":{"650":{"651":{"652":{"653":{"654":{"655":{"656":{"657":{"658":{"659":{"660":{"661":{"662":{"663":{"664":{"665":{"666":{"667":{"668":{"669":{"670":{"671":{"672":{"673":{"674":{"675":{"676":{"677":{"678":{"679":{"680":{"681":{"682":{"683":{"684":{"685":{"686":{"687":{"688":{"689":{"690":{"691":{"692":{"693":{"694":{"695":{"696":{"697":{"698":{"699":{"700":{"701":{"702":{"703":{"704":{"705":{"706":{"707":{"708":{"709":{"710":{"711":{"712":{"713":{"714":{"715":{"716":{"717":{"718":{"719":{"720":{"721":{"722":{"723":{"724":{"725":{"726":{"727":{"728":{"729":{"730":{"731":{"732":{"733":{"734":{"735":{"736":{"737":{"738":{"739":{"740":{"741":{"742":{"743":{"744":{"745":{"746":{"747":{"748":{"749":{"750":{"751":{"752":{"753":{"754":{"755":{"756":{"757":{"758":{"759":{"760":{"761":{"762":{"763":{"764":{"765":{"766":{"767":{"768":{"769":{"770":{"771":{"772":{"773":{"774":{"775":{"776":{"777":{"778":{"779":{"780":{"781":{"782":{"783":{"784":{"785":{"786":{"787":{"788":{"789":{"790":{"791":{"792":{"793":{"794":{"795":{"796":{"797":{"798":{"799":{"800":{"801":{"802":{"803":{"804":{"805":{"806":{"807":{"808":{"809":{"810":{"811":{"812":{"813":{"814":{"815":{"816":{"817":{"818":{"819":{"820":{"821":{"822":{"823":{"824":{"825":{"826":{"827":{"828":{"829":{"830":{"831":{"832":{"833":{"834":{"835":{"836":{"837":{"838":{"839":{"840":{"841":{"842":{"843":{"844":{"845":{"846":{"847":{"848":{"849":{"850":{"851":{"852":{"853":{"854":{"855":{"856":{"857":{"858":{"859":{"860":{"861":{"862":{"863":{"864":{"865":{"866":{"867":{"868":{"869":{"870":{"871":{"872":{"873":{"874":{"875":{"876":{"877":{"878":{"879":{"880":{"881":{"882":{"883":{"884":{"885":{"886":{"887":{"888":{"889":{"890":{"891":{"892":{"893":{"894":{"895":{"896":{"897":{"898":{"899":{"900":{"901":{"902":{"903":{"904":{"905":{"906":{"907":{"908":{"909":{"910":{"911":{"912":{"913":{"914":{"915":{"916":{"917":{"918":{"919":{"920":{"921":{"922":{"923":{"924":{"925":{"926":{"927":{"928":{"929":{"930":{"931":{"932":{"933":{"934":{"935":{"936":{"937":{"938":{"939":{"940":{"941":{"942":{"943":{"944":{"945":{"946":{"947":{"948":{"949":{"950":{"951":{"952":{"953":{"954":{"955":{"956":{"957":{"958":{"959":{"960":{"961":{"962":{"963":{"964":{"965":{"966":{"967":{"968":{"969":{"970":{"971":{"972":{"973":{"974":{"975":{"976":{"977":{"978":{"979":{"980":{"981":{"982":{"983":{"984":{"985":{"986":{"987":{"988":{"989":{"990":{"991":{"992":{"993":{"994":{"995":{"996":{"997":{"998":{"999":{"1000":{"final":"xxx"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}`,
			WantErr:    false,
		},
		{
			Name:       "1000 nested object inside array",
			Input:      `[{"1":{"2":{"3":{"4":{"5":{"6":{"7":{"8":{"9":{"10":{"11":{"12":{"13":{"14":{"15":{"16":{"17":{"18":{"19":{"20":{"21":{"22":{"23":{"24":{"25":{"26":{"27":{"28":{"29":{"30":{"31":{"32":{"33":{"34":{"35":{"36":{"37":{"38":{"39":{"40":{"41":{"42":{"43":{"44":{"45":{"46":{"47":{"48":{"49":{"50":{"51":{"52":{"53":{"54":{"55":{"56":{"57":{"58":{"59":{"60":{"61":{"62":{"63":{"64":{"65":{"66":{"67":{"68":{"69":{"70":{"71":{"72":{"73":{"74":{"75":{"76":{"77":{"78":{"79":{"80":{"81":{"82":{"83":{"84":{"85":{"86":{"87":{"88":{"89":{"90":{"91":{"92":{"93":{"94":{"95":{"96":{"97":{"98":{"99":{"100":{"101":{"102":{"103":{"104":{"105":{"106":{"107":{"108":{"109":{"110":{"111":{"112":{"113":{"114":{"115":{"116":{"117":{"118":{"119":{"120":{"121":{"122":{"123":{"124":{"125":{"126":{"127":{"128":{"129":{"130":{"131":{"132":{"133":{"134":{"135":{"136":{"137":{"138":{"139":{"140":{"141":{"142":{"143":{"144":{"145":{"146":{"147":{"148":{"149":{"150":{"151":{"152":{"153":{"154":{"155":{"156":{"157":{"158":{"159":{"160":{"161":{"162":{"163":{"164":{"165":{"166":{"167":{"168":{"169":{"170":{"171":{"172":{"173":{"174":{"175":{"176":{"177":{"178":{"179":{"180":{"181":{"182":{"183":{"184":{"185":{"186":{"187":{"188":{"189":{"190":{"191":{"192":{"193":{"194":{"195":{"196":{"197":{"198":{"199":{"200":{"201":{"202":{"203":{"204":{"205":{"206":{"207":{"208":{"209":{"210":{"211":{"212":{"213":{"214":{"215":{"216":{"217":{"218":{"219":{"220":{"221":{"222":{"223":{"224":{"225":{"226":{"227":{"228":{"229":{"230":{"231":{"232":{"233":{"234":{"235":{"236":{"237":{"238":{"239":{"240":{"241":{"242":{"243":{"244":{"245":{"246":{"247":{"248":{"249":{"250":{"251":{"252":{"253":{"254":{"255":{"256":{"257":{"258":{"259":{"260":{"261":{"262":{"263":{"264":{"265":{"266":{"267":{"268":{"269":{"270":{"271":{"272":{"273":{"274":{"275":{"276":{"277":{"278":{"279":{"280":{"281":{"282":{"283":{"284":{"285":{"286":{"287":{"288":{"289":{"290":{"291":{"292":{"293":{"294":{"295":{"296":{"297":{"298":{"299":{"300":{"301":{"302":{"303":{"304":{"305":{"306":{"307":{"308":{"309":{"310":{"311":{"312":{"313":{"314":{"315":{"316":{"317":{"318":{"319":{"320":{"321":{"322":{"323":{"324":{"325":{"326":{"327":{"328":{"329":{"330":{"331":{"332":{"333":{"334":{"335":{"336":{"337":{"338":{"339":{"340":{"341":{"342":{"343":{"344":{"345":{"346":{"347":{"348":{"349":{"350":{"351":{"352":{"353":{"354":{"355":{"356":{"357":{"358":{"359":{"360":{"361":{"362":{"363":{"364":{"365":{"366":{"367":{"368":{"369":{"370":{"371":{"372":{"373":{"374":{"375":{"376":{"377":{"378":{"379":{"380":{"381":{"382":{"383":{"384":{"385":{"386":{"387":{"388":{"389":{"390":{"391":{"392":{"393":{"394":{"395":{"396":{"397":{"398":{"399":{"400":{"401":{"402":{"403":{"404":{"405":{"406":{"407":{"408":{"409":{"410":{"411":{"412":{"413":{"414":{"415":{"416":{"417":{"418":{"419":{"420":{"421":{"422":{"423":{"424":{"425":{"426":{"427":{"428":{"429":{"430":{"431":{"432":{"433":{"434":{"435":{"436":{"437":{"438":{"439":{"440":{"441":{"442":{"443":{"444":{"445":{"446":{"447":{"448":{"449":{"450":{"451":{"452":{"453":{"454":{"455":{"456":{"457":{"458":{"459":{"460":{"461":{"462":{"463":{"464":{"465":{"466":{"467":{"468":{"469":{"470":{"471":{"472":{"473":{"474":{"475":{"476":{"477":{"478":{"479":{"480":{"481":{"482":{"483":{"484":{"485":{"486":{"487":{"488":{"489":{"490":{"491":{"492":{"493":{"494":{"495":{"496":{"497":{"498":{"499":{"500":{"501":{"502":{"503":{"504":{"505":{"506":{"507":{"508":{"509":{"510":{"511":{"512":{"513":{"514":{"515":{"516":{"517":{"518":{"519":{"520":{"521":{"522":{"523":{"524":{"525":{"526":{"527":{"528":{"529":{"530":{"531":{"532":{"533":{"534":{"535":{"536":{"537":{"538":{"539":{"540":{"541":{"542":{"543":{"544":{"545":{"546":{"547":{"548":{"549":{"550":{"551":{"552":{"553":{"554":{"555":{"556":{"557":{"558":{"559":{"560":{"561":{"562":{"563":{"564":{"565":{"566":{"567":{"568":{"569":{"570":{"571":{"572":{"573":{"574":{"575":{"576":{"577":{"578":{"579":{"580":{"581":{"582":{"583":{"584":{"585":{"586":{"587":{"588":{"589":{"590":{"591":{"592":{"593":{"594":{"595":{"596":{"597":{"598":{"599":{"600":{"601":{"602":{"603":{"604":{"605":{"606":{"607":{"608":{"609":{"610":{"611":{"612":{"613":{"614":{"615":{"616":{"617":{"618":{"619":{"620":{"621":{"622":{"623":{"624":{"625":{"626":{"627":{"628":{"629":{"630":{"631":{"632":{"633":{"634":{"635":{"636":{"637":{"638":{"639":{"640":{"641":{"642":{"643":{"644":{"645":{"646":{"647":{"648":{"649":{"650":{"651":{"652":{"653":{"654":{"655":{"656":{"657":{"658":{"659":{"660":{"661":{"662":{"663":{"664":{"665":{"666":{"667":{"668":{"669":{"670":{"671":{"672":{"673":{"674":{"675":{"676":{"677":{"678":{"679":{"680":{"681":{"682":{"683":{"684":{"685":{"686":{"687":{"688":{"689":{"690":{"691":{"692":{"693":{"694":{"695":{"696":{"697":{"698":{"699":{"700":{"701":{"702":{"703":{"704":{"705":{"706":{"707":{"708":{"709":{"710":{"711":{"712":{"713":{"714":{"715":{"716":{"717":{"718":{"719":{"720":{"721":{"722":{"723":{"724":{"725":{"726":{"727":{"728":{"729":{"730":{"731":{"732":{"733":{"734":{"735":{"736":{"737":{"738":{"739":{"740":{"741":{"742":{"743":{"744":{"745":{"746":{"747":{"748":{"749":{"750":{"751":{"752":{"753":{"754":{"755":{"756":{"757":{"758":{"759":{"760":{"761":{"762":{"763":{"764":{"765":{"766":{"767":{"768":{"769":{"770":{"771":{"772":{"773":{"774":{"775":{"776":{"777":{"778":{"779":{"780":{"781":{"782":{"783":{"784":{"785":{"786":{"787":{"788":{"789":{"790":{"791":{"792":{"793":{"794":{"795":{"796":{"797":{"798":{"799":{"800":{"801":{"802":{"803":{"804":{"805":{"806":{"807":{"808":{"809":{"810":{"811":{"812":{"813":{"814":{"815":{"816":{"817":{"818":{"819":{"820":{"821":{"822":{"823":{"824":{"825":{"826":{"827":{"828":{"829":{"830":{"831":{"832":{"833":{"834":{"835":{"836":{"837":{"838":{"839":{"840":{"841":{"842":{"843":{"844":{"845":{"846":{"847":{"848":{"849":{"850":{"851":{"852":{"853":{"854":{"855":{"856":{"857":{"858":{"859":{"860":{"861":{"862":{"863":{"864":{"865":{"866":{"867":{"868":{"869":{"870":{"871":{"872":{"873":{"874":{"875":{"876":{"877":{"878":{"879":{"880":{"881":{"882":{"883":{"884":{"885":{"886":{"887":{"888":{"889":{"890":{"891":{"892":{"893":{"894":{"895":{"896":{"897":{"898":{"899":{"900":{"901":{"902":{"903":{"904":{"905":{"906":{"907":{"908":{"909":{"910":{"911":{"912":{"913":{"914":{"915":{"916":{"917":{"918":{"919":{"920":{"921":{"922":{"923":{"924":{"925":{"926":{"927":{"928":{"929":{"930":{"931":{"932":{"933":{"934":{"935":{"936":{"937":{"938":{"939":{"940":{"941":{"942":{"943":{"944":{"945":{"946":{"947":{"948":{"949":{"950":{"951":{"952":{"953":{"954":{"955":{"956":{"957":{"958":{"959":{"960":{"961":{"962":{"963":{"964":{"965":{"966":{"967":{"968":{"969":{"970":{"971":{"972":{"973":{"974":{"975":{"976":{"977":{"978":{"979":{"980":{"981":{"982":{"983":{"984":{"985":{"986":{"987":{"988":{"989":{"990":{"991":{"992":{"993":{"994":{"995":{"996":{"997":{"998":{"999":{"1000":{"final":"value"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}]`,
			MaskedKeys: []string{"final"},
			WantOutput: `[{"1":{"2":{"3":{"4":{"5":{"6":{"7":{"8":{"9":{"10":{"11":{"12":{"13":{"14":{"15":{"16":{"17":{"18":{"19":{"20":{"21":{"22":{"23":{"24":{"25":{"26":{"27":{"28":{"29":{"30":{"31":{"32":{"33":{"34":{"35":{"36":{"37":{"38":{"39":{"40":{"41":{"42":{"43":{"44":{"45":{"46":{"47":{"48":{"49":{"50":{"51":{"52":{"53":{"54":{"55":{"56":{"57":{"58":{"59":{"60":{"61":{"62":{"63":{"64":{"65":{"66":{"67":{"68":{"69":{"70":{"71":{"72":{"73":{"74":{"75":{"76":{"77":{"78":{"79":{"80":{"81":{"82":{"83":{"84":{"85":{"86":{"87":{"88":{"89":{"90":{"91":{"92":{"93":{"94":{"95":{"96":{"97":{"98":{"99":{"100":{"101":{"102":{"103":{"104":{"105":{"106":{"107":{"108":{"109":{"110":{"111":{"112":{"113":{"114":{"115":{"116":{"117":{"118":{"119":{"120":{"121":{"122":{"123":{"124":{"125":{"126":{"127":{"128":{"129":{"130":{"131":{"132":{"133":{"134":{"135":{"136":{"137":{"138":{"139":{"140":{"141":{"142":{"143":{"144":{"145":{"146":{"147":{"148":{"149":{"150":{"151":{"152":{"153":{"154":{"155":{"156":{"157":{"158":{"159":{"160":{"161":{"162":{"163":{"164":{"165":{"166":{"167":{"168":{"169":{"170":{"171":{"172":{"173":{"174":{"175":{"176":{"177":{"178":{"179":{"180":{"181":{"182":{"183":{"184":{"185":{"186":{"187":{"188":{"189":{"190":{"191":{"192":{"193":{"194":{"195":{"196":{"197":{"198":{"199":{"200":{"201":{"202":{"203":{"204":{"205":{"206":{"207":{"208":{"209":{"210":{"211":{"212":{"213":{"214":{"215":{"216":{"217":{"218":{"219":{"220":{"221":{"222":{"223":{"224":{"225":{"226":{"227":{"228":{"229":{"230":{"231":{"232":{"233":{"234":{"235":{"236":{"237":{"238":{"239":{"240":{"241":{"242":{"243":{"244":{"245":{"246":{"247":{"248":{"249":{"250":{"251":{"252":{"253":{"254":{"255":{"256":{"257":{"258":{"259":{"260":{"261":{"262":{"263":{"264":{"265":{"266":{"267":{"268":{"269":{"270":{"271":{"272":{"273":{"274":{"275":{"276":{"277":{"278":{"279":{"280":{"281":{"282":{"283":{"284":{"285":{"286":{"287":{"288":{"289":{"290":{"291":{"292":{"293":{"294":{"295":{"296":{"297":{"298":{"299":{"300":{"301":{"302":{"303":{"304":{"305":{"306":{"307":{"308":{"309":{"310":{"311":{"312":{"313":{"314":{"315":{"316":{"317":{"318":{"319":{"320":{"321":{"322":{"323":{"324":{"325":{"326":{"327":{"328":{"329":{"330":{"331":{"332":{"333":{"334":{"335":{"336":{"337":{"338":{"339":{"340":{"341":{"342":{"343":{"344":{"345":{"346":{"347":{"348":{"349":{"350":{"351":{"352":{"353":{"354":{"355":{"356":{"357":{"358":{"359":{"360":{"361":{"362":{"363":{"364":{"365":{"366":{"367":{"368":{"369":{"370":{"371":{"372":{"373":{"374":{"375":{"376":{"377":{"378":{"379":{"380":{"381":{"382":{"383":{"384":{"385":{"386":{"387":{"388":{"389":{"390":{"391":{"392":{"393":{"394":{"395":{"396":{"397":{"398":{"399":{"400":{"401":{"402":{"403":{"404":{"405":{"406":{"407":{"408":{"409":{"410":{"411":{"412":{"413":{"414":{"415":{"416":{"417":{"418":{"419":{"420":{"421":{"422":{"423":{"424":{"425":{"426":{"427":{"428":{"429":{"430":{"431":{"432":{"433":{"434":{"435":{"436":{"437":{"438":{"439":{"440":{"441":{"442":{"443":{"444":{"445":{"446":{"447":{"448":{"449":{"450":{"451":{"452":{"453":{"454":{"455":{"456":{"457":{"458":{"459":{"460":{"461":{"462":{"463":{"464":{"465":{"466":{"467":{"468":{"469":{"470":{"471":{"472":{"473":{"474":{"475":{"476":{"477":{"478":{"479":{"480":{"481":{"482":{"483":{"484":{"485":{"486":{"487":{"488":{"489":{"490":{"491":{"492":{"493":{"494":{"495":{"496":{"497":{"498":{"499":{"500":{"501":{"502":{"503":{"504":{"505":{"506":{"507":{"508":{"509":{"510":{"511":{"512":{"513":{"514":{"515":{"516":{"517":{"518":{"519":{"520":{"521":{"522":{"523":{"524":{"525":{"526":{"527":{"528":{"529":{"530":{"531":{"532":{"533":{"534":{"535":{"536":{"537":{"538":{"539":{"540":{"541":{"542":{"543":{"544":{"545":{"546":{"547":{"548":{"549":{"550":{"551":{"552":{"553":{"554":{"555":{"556":{"557":{"558":{"559":{"560":{"561":{"562":{"563":{"564":{"565":{"566":{"567":{"568":{"569":{"570":{"571":{"572":{"573":{"574":{"575":{"576":{"577":{"578":{"579":{"580":{"581":{"582":{"583":{"584":{"585":{"586":{"587":{"588":{"589":{"590":{"591":{"592":{"593":{"594":{"595":{"596":{"597":{"598":{"599":{"600":{"601":{"602":{"603":{"604":{"605":{"606":{"607":{"608":{"609":{"610":{"611":{"612":{"613":{"614":{"615":{"616":{"617":{"618":{"619":{"620":{"621":{"622":{"623":{"624":{"625":{"626":{"627":{"628":{"629":{"630":{"631":{"632":{"633":{"634":{"635":{"636":{"637":{"638":{"639":{"640":{"641":{"642":{"643":{"644":{"645":{"646":{"647":{"648":{"649":{"650":{"651":{"652":{"653":{"654":{"655":{"656":{"657":{"658":{"659":{"660":{"661":{"662":{"663":{"664":{"665":{"666":{"667":{"668":{"669":{"670":{"671":{"672":{"673":{"674":{"675":{"676":{"677":{"678":{"679":{"680":{"681":{"682":{"683":{"684":{"685":{"686":{"687":{"688":{"689":{"690":{"691":{"692":{"693":{"694":{"695":{"696":{"697":{"698":{"699":{"700":{"701":{"702":{"703":{"704":{"705":{"706":{"707":{"708":{"709":{"710":{"711":{"712":{"713":{"714":{"715":{"716":{"717":{"718":{"719":{"720":{"721":{"722":{"723":{"724":{"725":{"726":{"727":{"728":{"729":{"730":{"731":{"732":{"733":{"734":{"735":{"736":{"737":{"738":{"739":{"740":{"741":{"742":{"743":{"744":{"745":{"746":{"747":{"748":{"749":{"750":{"751":{"752":{"753":{"754":{"755":{"756":{"757":{"758":{"759":{"760":{"761":{"762":{"763":{"764":{"765":{"766":{"767":{"768":{"769":{"770":{"771":{"772":{"773":{"774":{"775":{"776":{"777":{"778":{"779":{"780":{"781":{"782":{"783":{"784":{"785":{"786":{"787":{"788":{"789":{"790":{"791":{"792":{"793":{"794":{"795":{"796":{"797":{"798":{"799":{"800":{"801":{"802":{"803":{"804":{"805":{"806":{"807":{"808":{"809":{"810":{"811":{"812":{"813":{"814":{"815":{"816":{"817":{"818":{"819":{"820":{"821":{"822":{"823":{"824":{"825":{"826":{"827":{"828":{"829":{"830":{"831":{"832":{"833":{"834":{"835":{"836":{"837":{"838":{"839":{"840":{"841":{"842":{"843":{"844":{"845":{"846":{"847":{"848":{"849":{"850":{"851":{"852":{"853":{"854":{"855":{"856":{"857":{"858":{"859":{"860":{"861":{"862":{"863":{"864":{"865":{"866":{"867":{"868":{"869":{"870":{"871":{"872":{"873":{"874":{"875":{"876":{"877":{"878":{"879":{"880":{"881":{"882":{"883":{"884":{"885":{"886":{"887":{"888":{"889":{"890":{"891":{"892":{"893":{"894":{"895":{"896":{"897":{"898":{"899":{"900":{"901":{"902":{"903":{"904":{"905":{"906":{"907":{"908":{"909":{"910":{"911":{"912":{"913":{"914":{"915":{"916":{"917":{"918":{"919":{"920":{"921":{"922":{"923":{"924":{"925":{"926":{"927":{"928":{"929":{"930":{"931":{"932":{"933":{"934":{"935":{"936":{"937":{"938":{"939":{"940":{"941":{"942":{"943":{"944":{"945":{"946":{"947":{"948":{"949":{"950":{"951":{"952":{"953":{"954":{"955":{"956":{"957":{"958":{"959":{"960":{"961":{"962":{"963":{"964":{"965":{"966":{"967":{"968":{"969":{"970":{"971":{"972":{"973":{"974":{"975":{"976":{"977":{"978":{"979":{"980":{"981":{"982":{"983":{"984":{"985":{"986":{"987":{"988":{"989":{"990":{"991":{"992":{"993":{"994":{"995":{"996":{"997":{"998":{"999":{"1000":{"final":"xxx"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}]`,
			WantErr:    false,
		},
		{
			Name:       "all json type: string_only",
			Input:      allJSONType,
			MaskedKeys: []string{"string_only"},
			WantOutput: `{"array_string":["Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.","Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.","Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.","Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."],"float32":1.1,"float64":1.1,"int":-1,"int16":-1,"int32":-1,"int64":-1,"int8":-1,"map":{"array_string":["Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.","Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.","Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.","Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."],"float32":1.1,"float64":1.1,"int":-1,"int16":-1,"int32":-1,"int64":-1,"int8":-1,"map":{"foo":"bar"},"string_only":"xxx","uint":-1,"uint16":-1,"uint32":-1,"uint64":-1,"uint8":-1},"string_only":"xxx","string_quoted":"\"","uint":-1,"uint16":-1,"uint32":-1,"uint64":-1,"uint8":-1}`,
			WantErr:    false,
		},
		{
			Name:       "all json type: array_string",
			Input:      allJSONType,
			MaskedKeys: []string{"array_string"},
			WantOutput: `{"array_string":["xxx","xxx","xxx","xxx"],"float32":1.1,"float64":1.1,"int":-1,"int16":-1,"int32":-1,"int64":-1,"int8":-1,"map":{"array_string":["xxx","xxx","xxx","xxx"],"float32":1.1,"float64":1.1,"int":-1,"int16":-1,"int32":-1,"int64":-1,"int8":-1,"map":{"foo":"bar"},"string_only":"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.","uint":-1,"uint16":-1,"uint32":-1,"uint64":-1,"uint8":-1},"string_only":"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.","string_quoted":"\"","uint":-1,"uint16":-1,"uint32":-1,"uint64":-1,"uint8":-1}`,
			WantErr:    false,
		},
		{
			Name:       "large array: email",
			Input:      largeArray,
			MaskedKeys: []string{"email", "fullName", "familyName"},
			WantOutput: `[{"company":"hello","person":{"aboutme":{"avatar":null,"bio":null,"handle":"leonid.bugaev"},"angellist":{"avatar":"https://d1qb2nb5cznatu.cloudfront.net/users/61541-medium_jpg?1405474390","bio":"Senior engineer at Granify.com","blog":"http://buger.github.com","followers":41,"handle":"leonid-bugaev","id":61541,"site":"http://buger.github.com"},"avatar":"https://d1ts43dypk8bqh.cloudfront.net/v1/avatars/d50887ca-a6ce-4e59-b89f-14f0b5d03b03","bio":"Senior engineer at Granify.com","email":"xxx","employment":{"domain":"gmail.com","name":"www.latera.ru","title":"Software Engineer"},"facebook":{"handle":"leonid.bugaev"},"foursquare":{"handle":null},"fuzzy":false,"gender":"male","geo":{"city":"Saint Petersburg","country":"Russia","lat":59.9342802,"lng":30.3350986,"state":"Saint Petersburg"},"github":{"avatar":"https://avatars.githubusercontent.com/u/14009?v=3","blog":"http://leonsbox.com","company":"Granify","followers":95,"following":10,"handle":"buger","id":14009},"googleplus":{"handle":null},"gravatar":{"avatar":"http://1.gravatar.com/avatar/f7c8edd577d13b8930d5522f28123510","avatars":[{"type":"thumbnail","url":"http://1.gravatar.com/avatar/f7c8edd577d13b8930d5522f28123510"}],"handle":"buger","urls":[]},"id":"d50887ca-a6ce-4e59-b89f-14f0b5d03b03","klout":{"handle":null,"score":null},"linkedin":{"handle":"in/leonidbugaev"},"location":"Saint Petersburg, Saint Petersburg, RU","name":{"familyName":"xxx","fullName":"xxx","givenName":"Leonid"},"site":"http://flickfaver.com","twitter":{"avatar":null,"bio":null,"favorites":0,"followers":2,"following":1,"handle":"flickfaver","id":77004410,"location":"","site":"http://flickfaver.com","statuses":5}}}]`,
			WantErr:    false,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.Name, func(t *testing.T) {
			config := jsonutil.Config{
				StringTransformer: transformer(tc.MaskedKeys),
			}

			mask := jsonutil.NewTransformer(config)
			out, err := mask.TransformBytes(context.Background(), []byte(tc.Input))
			if err != nil && !tc.WantErr {
				t.Errorf("code should not error, but got an error: \n\t%s", err)
				return
			}

			if string(out) != tc.WantOutput {
				t.Errorf("\nwant:\n \t%s \ngot:\n\t%s\n", tc.WantOutput, out)
				return
			}

			t.Logf("%s", out)
		})
	}

}

// TestTransformer_TransformBytes_GoRoutine test using Go routine to early detect race condition if occurs.
func TestTransformer_TransformBytes_GoRoutine(t *testing.T) {
	config := jsonutil.Config{
		StringTransformer: func(ctx context.Context, info jsonutil.KVInfo) string {
			if info.Key == "email" {
				return "xxx"
			}

			return info.Value
		},
	}

	transformer := jsonutil.NewTransformer(config)

	N := 1000
	wg := sync.WaitGroup{}
	wg.Add(N)

	for i := 0; i < N; i++ {
		go func() {
			defer wg.Done()
			_, err := transformer.TransformBytes(context.Background(), []byte(largeArray))
			if err != nil {
				t.Error(err)
				return
			}
		}()
	}

	wg.Wait()
}

func BenchmarkTransformer_Transform(b *testing.B) {

	// No transform function defined, this to benchmark the actual process,
	// minimizing overhead of function call and processing.
	mask := jsonutil.NewTransformer(jsonutil.Config{})

	b.Run("large array", func(b *testing.B) {
		by := []byte(largeArray)
		var data interface{}
		err := json.Unmarshal(by, &data)
		if err != nil {
			b.Error(err)
			return
		}

		for i := 0; i < b.N; i++ {
			_, err := mask.Transform(context.Background(), data)
			if err != nil {
				b.Log(err)
				b.Error(err)
				return
			}
		}
	})

	b.Run("all JSON type", func(b *testing.B) {
		by := []byte(allJSONType)
		var data interface{}
		err := json.Unmarshal(by, &data)
		if err != nil {
			b.Error(err)
			return
		}

		for i := 0; i < b.N; i++ {
			_, err := mask.Transform(context.Background(), data)
			if err != nil {
				b.Log(err)
				b.Error(err)
				return
			}
		}
	})

	b.Run("nested 100 object", func(b *testing.B) {
		by := []byte(nestedObject100)
		var data interface{}
		err := json.Unmarshal(by, &data)
		if err != nil {
			b.Error(err)
			return
		}

		for i := 0; i < b.N; i++ {
			_, err := mask.Transform(context.Background(), data)
			if err != nil {
				b.Log(err)
				b.Error(err)
				return
			}
		}
	})

	b.Run("nested 1000 object", func(b *testing.B) {
		by := []byte(nestedObject1000)
		var data interface{}
		err := json.Unmarshal(by, &data)
		if err != nil {
			b.Error(err)
			return
		}

		for i := 0; i < b.N; i++ {
			_, err := mask.Transform(context.Background(), data)
			if err != nil {
				b.Log(err)
				b.Error(err)
				return
			}
		}
	})

}
